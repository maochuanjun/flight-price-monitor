name: Flight Price Monitor

on:
  schedule:
    - cron: "*/10 * * * *" # 每十分钟运行一次
  workflow_dispatch: # 允许手动触发

jobs:
  check-prices:
    runs-on: ubuntu-latest

    env:
      # 配置环境变量，这些值需要在 GitHub 仓库的 Settings -> Secrets and variables -> Actions 中设置
      DATE_TO_GO: ${{ secrets.DATE_TO_GO }}
      PLACE_FROM: ${{ secrets.PLACE_FROM }}
      PLACE_TO: ${{ secrets.PLACE_TO }}
      FLIGHT_WAY: ${{ secrets.FLIGHT_WAY }}
      PRICE_STEP: ${{ secrets.PRICE_STEP }}
      EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
      SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f GitHub/requirements.txt ]; then pip install -r GitHub/requirements.txt; fi

      - name: Run flight check script
        # 注意：这里假设脚本在 GitHub 目录下，且工作目录是仓库根目录
        # 脚本会读取/写入 GitHub/price_history.json (因为我们在脚本里定义的是相对路径)
        # 我们需要确保脚本里的 HISTORY_FILE 路径是正确的，或者在运行前切换目录
        run: |
          cd GitHub
          python flight_alert_action.py

      - name: Commit and push if changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          # 检查是否有变化
          if [[ -n $(git status -s GitHub/price_history.json) ]]; then
            git add GitHub/price_history.json
            git commit -m "Update price history [skip ci]"
            git push
          else
            echo "No changes in price history."
          fi
